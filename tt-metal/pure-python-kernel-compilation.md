# Pure-Python Kernel Compilation (Blackhole)

This note captures what tt-metal’s JIT does for BRISC/NCRISC/TRISC so a pure-Python launcher can compile kernels and upload the raw ELFs. It is based on the Blackhole HAL and JIT sources.

## One compiler, multiple builds

tt-metal uses a single compiler binary:

- `runtime/sfpi/compiler/bin/riscv-tt-elf-g++`

but it runs it **separately** for:

- BRISC (data-movement writer)
- NCRISC (data-movement reader)
- TRISC0/1/2 (compute: unpack / math / pack)

The difference is **defines**, **linker scripts**, and sometimes **link objects**.

## Why do TRISC builds need `chlkc_*` files?

TRISC kernels are compiled through `trisck.cc`, which includes `chlkc_list.h`. That file expects to include:

- Generated per-trisc C++ source wrappers:
  - `chlkc_unpack.cpp`
  - `chlkc_math.cpp`
  - `chlkc_pack.cpp`
- Generated descriptors used by the compute kernel:
  - `chlkc_unpack_data_format.h`
  - `chlkc_pack_data_format.h`
  - `chlkc_unpack_tile_dims.h`
  - `chlkc_pack_tile_dims.h`
  - `chlkc_dst_accum_mode.h`
  - `chlkc_dst_sync_mode.h`
  - `chlkc_math_fidelity.h`
  - `chlkc_math_approx_mode.h`
- `defines_generated.h` (defines added via kernel config)

These files are generated by tt-metal in `tt_metal/jit_build/genfiles.cpp`. They are derived from:

- Your kernel source string
- CB data formats and tile dims
- Compute config (math fidelity, approx, fp32 dest, dst sync)

**Bottom line:** For compute kernels, the kernel source string is not enough. You must generate the `chlkc_*` files (or reuse JIT outputs). For BRISC/NCRISC dataflow kernels, you only need a generated `kernel_includes.hpp` that includes the kernel source.

## Why are there three TRISC ELFs?

TRISC0/1/2 run **different roles** (unpack, math, pack). The JIT compiles the **same kernel source** three times with different defines, so the binaries differ:

- TRISC0: `UCK_CHLKC_UNPACK`, `COMPILE_FOR_TRISC=0`, includes `chlkc_unpack_*`
- TRISC1: `UCK_CHLKC_MATH`, `COMPILE_FOR_TRISC=1`, includes `chlkc_math_*`
- TRISC2: `UCK_CHLKC_PACK`, `COMPILE_FOR_TRISC=2`, includes `chlkc_pack_*`

That is why you upload **three different ELFs**. Uploading the same ELF to all TRISCs would only work if you wrote a custom kernel that branches at runtime based on the TRISC ID and carries unpack+math+pack in one binary (not how the default pipeline is built).

## Minimal generated files (per kernel)

Dataflow kernel (BRISC/NCRISC):
- `kernel_includes.hpp` (wraps the kernel source as an include)

Compute kernel (TRISC0/1/2):
- `chlkc_unpack.cpp`, `chlkc_math.cpp`, `chlkc_pack.cpp`
- `defines_generated.h`
- `chlkc_unpack_data_format.h`, `chlkc_pack_data_format.h`
- `chlkc_unpack_tile_dims.h`, `chlkc_pack_tile_dims.h`
- `chlkc_dst_accum_mode.h`, `chlkc_dst_sync_mode.h`
- `chlkc_math_fidelity.h`, `chlkc_math_approx_mode.h`

## Compiler flags and linker scripts (Blackhole)

All of these come from:
- `tt_metal/jit_build/build.cpp`
- `tt_metal/llrt/hal/tt-1xx/blackhole/bh_hal.cpp`
- `tt_metal/llrt/hal/tt-1xx/hal_1xx_common.cpp`

### Common flags (all RISCs)
```
-std=c++17 -flto=auto -ffast-math -fno-exceptions
-MMD -fno-use-cxa-atexit
-Wall -Werror -Wno-unknown-pragmas -Wno-deprecated-declarations
-Wno-error=multistatement-macros -Wno-error=parentheses
-Wno-error=unused-but-set-variable -Wno-unused-variable -Wno-unused-function
```

Linker flags:
```
-Wl,-z,max-page-size=16 -Wl,-z,common-page-size=16 -nostartfiles
-Wl,--emit-relocs
```

### BRISC (writer)
- Source: `tt_metal/hw/firmware/src/tt-1xx/brisck.cc`
- Linker script: `runtime/hw/toolchain/blackhole/kernel_brisc.ld`
- Extra objs: `runtime/hw/lib/blackhole/noc.o`, `runtime/hw/lib/blackhole/substitutes.o`
- Defines:
  - `COMPILE_FOR_BRISC`, `PROCESSOR_INDEX=0`, `ARCH_BLACKHOLE`, `KERNEL_BUILD`

### NCRISC (reader)
- Source: `tt_metal/hw/firmware/src/tt-1xx/ncrisck.cc`
- Linker script: `runtime/hw/toolchain/blackhole/kernel_ncrisc.ld`
- Extra objs: `runtime/hw/lib/blackhole/substitutes.o`
- Defines:
  - `COMPILE_FOR_NCRISC`, `PROCESSOR_INDEX=1`, `ARCH_BLACKHOLE`, `KERNEL_BUILD`

### TRISC0/1/2 (compute)
- Source: `tt_metal/hw/firmware/src/tt-1xx/trisck.cc`
- Linker scripts:
  - `runtime/hw/toolchain/blackhole/kernel_trisc0.ld`
  - `runtime/hw/toolchain/blackhole/kernel_trisc1.ld`
  - `runtime/hw/toolchain/blackhole/kernel_trisc2.ld`
- Extra objs: `runtime/hw/lib/blackhole/substitutes.o`
- Defines (per TRISC):
  - TRISC0: `UCK_CHLKC_UNPACK`, `NAMESPACE=chlkc_unpack`, `COMPILE_FOR_TRISC=0`, `PROCESSOR_INDEX=2`
  - TRISC1: `UCK_CHLKC_MATH`, `NAMESPACE=chlkc_math`, `COMPILE_FOR_TRISC=1`, `PROCESSOR_INDEX=3`
  - TRISC2: `UCK_CHLKC_PACK`, `NAMESPACE=chlkc_pack`, `COMPILE_FOR_TRISC=2`, `PROCESSOR_INDEX=4`

### Dispatch message define

All kernels also define:
```
DISPATCH_MESSAGE_ADDR=<value>
```
This comes from `DispatchMemMap::get_dispatch_message_addr_start()` in `tt_metal/impl/dispatch/dispatch_mem_map.cpp`.

## Practical shortcut (bootstrap)

If you want to avoid reimplementing `chlkc_*` generation:

1) Run the original example once with JIT enabled.
2) Grab the ELFs from `~/.cache/tt-metal-cache/<git_hash>/<build_key>/kernels/...`.

See `boop-docs/tt-metal/jit-kernel-binaries.md` for the cache layout.

## Blackhole firmware sources

Firmware is built from C++ sources in `tt_metal/hw/firmware/src/tt-1xx/` (not blobs). The Blackhole HAL selects these
sources for `is_fw=true` builds:

Tensix (worker tiles):
- `tt_metal/hw/firmware/src/tt-1xx/brisc.cc`
- `tt_metal/hw/firmware/src/tt-1xx/ncrisc.cc`
- `tt_metal/hw/firmware/src/tt-1xx/trisc.cc`

Ethernet / idle ETH (if enabled):
- `tt_metal/hw/firmware/src/tt-1xx/active_erisc.cc`
- `tt_metal/hw/firmware/src/tt-1xx/active_erisc-crt0.cc` (2‑ERISC mode only)
- `tt_metal/hw/firmware/src/tt-1xx/subordinate_erisc.cc`
- `tt_metal/hw/firmware/src/tt-1xx/idle_erisc.cc`

Kernel wrappers (not firmware, used for per‑kernel builds):
- `tt_metal/hw/firmware/src/tt-1xx/brisck.cc`
- `tt_metal/hw/firmware/src/tt-1xx/ncrisck.cc`
- `tt_metal/hw/firmware/src/tt-1xx/trisck.cc`
- `tt_metal/hw/firmware/src/tt-1xx/active_erisck.cc`
- `tt_metal/hw/firmware/src/tt-1xx/idle_erisck.cc`

## Reference files

- `tt_metal/jit_build/build.cpp`
- `tt_metal/jit_build/genfiles.cpp`
- `tt_metal/llrt/hal/tt-1xx/blackhole/bh_hal.cpp`
- `tt_metal/llrt/hal/tt-1xx/hal_1xx_common.cpp`
- `tt_metal/hw/firmware/src/tt-1xx/brisck.cc`
- `tt_metal/hw/firmware/src/tt-1xx/ncrisck.cc`
- `tt_metal/hw/firmware/src/tt-1xx/trisck.cc`
- `tt_metal/hw/ckernels/blackhole/metal/common/chlkc_list.h`
